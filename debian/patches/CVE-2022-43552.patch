From: Samuel Henrique <samueloph@debian.org>
Date: Tue, 27 Dec 2022 00:05:50 +0000
Subject: smb/telnet: do not free the protocol struct in *_done() (CVE-2022-43552)

Origin: https://github.com/curl/curl/commit/4f20188ac644afe174be6005ef4f6ffba232b8b2
---
 lib/smb.c    | 14 ++------------
 lib/telnet.c |  3 ---
 2 files changed, 2 insertions(+), 15 deletions(-)

Index: curl/lib/smb.c
===================================================================
--- curl.orig/lib/smb.c
+++ curl/lib/smb.c
@@ -59,8 +59,6 @@ static CURLcode smb_connect(struct conne
 static CURLcode smb_connection_state(struct connectdata *conn, bool *done);
 static CURLcode smb_do(struct connectdata *conn, bool *done);
 static CURLcode smb_request_state(struct connectdata *conn, bool *done);
-static CURLcode smb_done(struct connectdata *conn, CURLcode status,
-                         bool premature);
 static CURLcode smb_disconnect(struct connectdata *conn, bool dead);
 static int smb_getsock(struct connectdata *conn, curl_socket_t *socks);
 static CURLcode smb_parse_url_path(struct connectdata *conn);
@@ -72,7 +70,7 @@ const struct Curl_handler Curl_handler_s
   "SMB",                                /* scheme */
   smb_setup_connection,                 /* setup_connection */
   smb_do,                               /* do_it */
-  smb_done,                             /* done */
+  ZERO_NULL,                            /* done */
   ZERO_NULL,                            /* do_more */
   smb_connect,                          /* connect_it */
   smb_connection_state,                 /* connecting */
@@ -98,7 +96,7 @@ const struct Curl_handler Curl_handler_s
   "SMBS",                               /* scheme */
   smb_setup_connection,                 /* setup_connection */
   smb_do,                               /* do_it */
-  smb_done,                             /* done */
+  ZERO_NULL,                            /* done */
   ZERO_NULL,                            /* do_more */
   smb_connect,                          /* connect_it */
   smb_connection_state,                 /* connecting */
@@ -919,14 +917,6 @@ static CURLcode smb_request_state(struct
   return CURLE_OK;
 }
 
-static CURLcode smb_done(struct connectdata *conn, CURLcode status,
-                         bool premature)
-{
-  (void) premature;
-  Curl_safefree(conn->data->req.p.smb);
-  return status;
-}
-
 static CURLcode smb_disconnect(struct connectdata *conn, bool dead)
 {
   struct smb_conn *smbc = &conn->proto.smbc;
Index: curl/lib/telnet.c
===================================================================
--- curl.orig/lib/telnet.c
+++ curl/lib/telnet.c
@@ -1250,8 +1250,6 @@ static CURLcode telnet_done(struct conne
   curl_slist_free_all(tn->telnet_vars);
   tn->telnet_vars = NULL;
 
-  Curl_safefree(conn->data->req.p.telnet);
-
   return CURLE_OK;
 }
 
